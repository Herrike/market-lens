import{u as p}from"./react-BL7NZTwX.js";const d=()=>({baseUrl:"https://financialmodelingprep.com",apiKey:"SEFOLM4uCgjHUY8Cj7uKCGcETFmbhfFk"});function A(e,r,t){let o=e.baseUrl;r.includes("search-symbol")&&(o="https://financialmodelingprep.com");const n=new URL(`${o}${r}`);return n.searchParams.append("apikey",e.apiKey),t&&Object.entries(t).forEach(([a,s])=>{n.searchParams.append(a,s.toString())}),n.toString()}const T=new RegExp(/^[A-Z0-9^.\-:]{1,10}$/i);function C(e){if(!e||e.trim().length===0)throw new Error("Search query cannot be empty");const r=e.trim().toUpperCase();if(!T.test(r))throw new Error("Invalid stock symbol format");return r}async function $(e,r=fetch){try{const t=await r(e);if(!t.ok){const n=`HTTP ${t.status}: ${t.statusText}`;throw new Error(n)}return await t.json()}catch(t){throw{name:t instanceof Error?t.name:"ApiError",message:t instanceof Error?t.message:"An unknown error occurred",status:t instanceof Response?t.status:void 0}}}async function I(e,r=10,t=d(),o=fetch){const n=C(e),a=A(t,"/stable/search-symbol",{query:n,limit:r});return $(a,o)}const M={searchStocks:(e,r)=>I(e,r,d())},se=Object.freeze(Object.defineProperty({__proto__:null,apiService:M,buildApiUrl:A,getDefaultConfig:d,makeApiRequest:$,searchStocks:I,validateStockQuery:C},Symbol.toStringTag,{value:"Module"})),f={keyPrefix:"market-lens",durations:{stockSearch:1440*60*1e3,stockDetails:14400*1e3,stockHistory1Day:360*60*1e3},swr:{dedupingInterval:30*1e3,errorRetryCount:2,errorRetryInterval:1e3,revalidateOnFocus:!1,revalidateOnReconnect:!1}};function g(e,r){return`${f.keyPrefix}-${e}-${r}`}function y(e,r){const t=g(e,r),o=f.durations[e];try{const n=localStorage.getItem(t);if(!n)return!1;const{timestamp:a}=JSON.parse(n);return Date.now()-a>o?(localStorage.removeItem(t),!1):!0}catch(n){return console.warn(`Cache validation failed for ${t}:`,n),!1}}function k(e,r){const t=g(e,r);try{const o=localStorage.getItem(t);if(!o)return null;const{data:n,timestamp:a}=JSON.parse(o),s=f.durations[e];return Date.now()-a>s?(localStorage.removeItem(t),null):n}catch(o){return console.warn(`Cache read failed for ${t}:`,o),null}}function E(e,r,t){const o=g(e,r);try{localStorage.setItem(o,JSON.stringify({data:t,timestamp:Date.now()}))}catch(n){console.warn(`Cache write failed for ${o}:`,n)}}function N(e,r){const t=g(e,r);localStorage.removeItem(t)}function q(e,r=10){const t=e&&e.length>=1,o=`${e}-${r}`,n=t&&y("stockSearch",o),a=n?k("stockSearch",o):null,s=t&&!n,{data:i,error:c,isLoading:w,mutate:l}=p(s?`/search-${e}-${r}`:null,async()=>{console.log(`📡 Fetching from API for query: "${e}"`);const S=await M.searchStocks(e,r);return E("stockSearch",o,S),S},{...f.swr});return{data:a||i||[],error:c,isLoading:!n&&w,refetch:l,clearCache:()=>N("stockSearch",o),isCached:n}}function K(e){if(!e)return null;const r=e.toUpperCase().trim(),t=`${f.keyPrefix}-stockSearch-`;for(let o=0;o<localStorage.length;o++){const n=localStorage.key(o);if(n&&n.startsWith(t))try{const a=localStorage.getItem(n);if(a){const{data:s,timestamp:i}=JSON.parse(a),c=f.durations.stockSearch;if(!(Date.now()-i>c)&&Array.isArray(s)){const l=s.find(m=>m.symbol.toUpperCase()===r);if(l)return l}}}catch(a){console.warn(`Error reading cache key ${n}:`,a)}}return null}function ce(e){const{data:r,error:t,isLoading:o}=q(e||"",1),n=e?K(e):null;return n?{stock:n,isLoading:!1,error:void 0}:{stock:r&&r.length>0?r[0]:null,isLoading:e?o:!1,error:e?t:void 0}}function R(e,r){return y(e,`failed-${r}`)}function h(e,r,t){E(e,`failed-${r}`,{error:t,timestamp:Date.now()})}function H(e,r){return k(e,`failed-${r}`)}function F(e,r){return y(e,r)}function L(e,r){return k(e,r)}function P(e,r,t){E(e,r,t)}function u(e,r,t,o=!1){const n=new Error(e);return Object.assign(n,{name:r,status:t,retryable:o}),n}function j(e){return u(e,"CachedFailure",0,!1)}function b(e,r,t,o){const n=`API request failed: ${e.status} ${e.statusText}`;if(e.status===402){const a=`${n} - API usage limit reached`;throw h(r,t,a),u(a,"PaymentRequiredError",402,!1)}if(e.status===403){const a=`${n} - Check your API key permissions`;throw h(r,t,a),u(a,"ForbiddenError",403,!1)}if(e.status===401){const a=`${n} - Invalid API key`;throw h(r,t,a),u(a,"UnauthorizedError",401,!1)}if(e.status===404){const a=`${n} - Stock symbol not found`;throw h(r,t,a),u(a,"NotFoundError",404,!1)}throw e.status>=500?u(`${n} - Server error, will retry`,"ServerError",e.status,!0):u(n,"ClientError",e.status,!1)}function x(e){return[401,402,403,404].includes(e)}function Q(e){return!(e.retryable===!1||e.status&&x(e.status))}function V(e){if(typeof e!="object"||e===null)return!1;const r="Error"in e&&typeof e.Error=="object"&&e.Error!==null&&"Message"in e.Error&&typeof e.Error.Message=="string",t="Error Message"in e&&typeof e["Error Message"]=="string";return r||t}function _(e){if(!Array.isArray(e))return!1;if(e.length===0)return!0;const r=e[0];return typeof r!="object"||r===null?!1:"symbol"in r&&typeof r.symbol=="string"&&"date"in r&&typeof r.date=="string"&&"price"in r&&typeof r.price=="number"}function Y(e){if(V(e)){if(e.Error?.Message)throw new Error(e.Error.Message);if(e["Error Message"])throw new Error(e["Error Message"])}if(!_(e))throw console.error("Unexpected API response format:",e),new Error("No historical data found in API response")}function J(e,r){return Y(e),{data:e.map(a=>({symbol:a.symbol,date:a.date,price:a.price,volume:a.volume||0})),symbol:r}}function O(e,r,t=2,o=3e3){return(n,a,s,i,{retryCount:c})=>{if(!Q(n)){r.add(e.toLowerCase());return}if(n.status&&x(n.status)){r.add(e.toLowerCase());return}c>=t||n.status&&n.status>=500&&setTimeout(()=>i({retryCount:c}),o)}}const U={revalidateOnFocus:!1,revalidateOnReconnect:!1,dedupingInterval:300*1e3,errorRetryInterval:1e4};function z(e){const r=new Date;return r.setDate(r.getDate()-e),r.toISOString().split("T")[0]}function G(){return z(15)}function W(){return new Date().toISOString().split("T")[0]}function B(){return{fromDate:G(),toDate:W()}}async function Z(e){if(!e)throw new Error("Stock symbol is required");if(R("stockHistory1Day",e)){const c=H("stockHistory1Day",e);if(c)throw j(c.error)}if(F("stockHistory1Day",e)){const c=L("stockHistory1Day",e);if(c)return c}const r="SEFOLM4uCgjHUY8Cj7uKCGcETFmbhfFk",{fromDate:t,toDate:o}=B(),n=`https://financialmodelingprep.com/stable/historical-price-eod/light?symbol=${e}&from=${t}&to=${o}&apikey=${r}`,a=await fetch(n);a.ok||b(a,"stockHistory1Day",e);const s=await a.json(),i=J(s,e);return P("stockHistory1Day",e,i),i}const D=new Set;function ie(e){const r=!!(e&&e.length>0&&!D.has(e.toLowerCase())),{data:t,error:o,isLoading:n,mutate:a}=p(r?["stock-history",e]:null,()=>Z(e),{...U,dedupingInterval:600*1e3,errorRetryInterval:15e3,onErrorRetry:O(e,D,2,5e3)});return{data:t||{data:[],symbol:e},error:o,isLoading:n,mutate:a}}function X(e){if(typeof e!="object"||e===null)return!1;const r="Error"in e&&typeof e.Error=="object"&&e.Error!==null&&"Message"in e.Error&&typeof e.Error.Message=="string",t="Error Message"in e&&typeof e["Error Message"]=="string";return r||t}function ee(e){if(!Array.isArray(e)||e.length===0)return!1;const r=e[0];return typeof r!="object"||r===null?!1:"symbol"in r&&typeof r.symbol=="string"&&"price"in r&&typeof r.price=="number"&&"changesPercentage"in r&&typeof r.changesPercentage=="number"&&"change"in r&&typeof r.change=="number"&&"dayLow"in r&&typeof r.dayLow=="number"&&"dayHigh"in r&&typeof r.dayHigh=="number"&&"yearHigh"in r&&typeof r.yearHigh=="number"&&"yearLow"in r&&typeof r.yearLow=="number"&&"marketCap"in r&&typeof r.marketCap=="number"&&"priceAvg50"in r&&typeof r.priceAvg50=="number"&&"priceAvg200"in r&&typeof r.priceAvg200=="number"&&"volume"in r&&typeof r.volume=="number"&&"avgVolume"in r&&typeof r.avgVolume=="number"}function re(e){if(X(e)){if(e.Error?.Message)throw new Error(e.Error.Message);if(e["Error Message"])throw new Error(e["Error Message"])}if(!ee(e))throw console.error("Unexpected API response format:",e),new Error("No quote data found in API response")}function te(e,r){re(e);const o=e[0];return{quote:{symbol:o.symbol,name:o.name||r,price:o.price,changesPercentage:o.changesPercentage,change:o.change,dayLow:o.dayLow,dayHigh:o.dayHigh,yearHigh:o.yearHigh,yearLow:o.yearLow,marketCap:o.marketCap,priceAvg50:o.priceAvg50,priceAvg200:o.priceAvg200,volume:o.volume,avgVolume:o.avgVolume,timestamp:o.timestamp||Date.now()},symbol:r,fallbackMode:!0}}async function oe(e){if(!e)throw new Error("Stock symbol is required");if(R("stockDetails",e)){const s=H("stockDetails",e);if(s)throw j(s.error)}if(F("stockDetails",e)){const s=L("stockDetails",e);if(s)return console.log(`📦 Using cached quote data for ${e}`),s}const r="SEFOLM4uCgjHUY8Cj7uKCGcETFmbhfFk";console.log(`🔍 Fetching quote data for ${e}...`);const t=`https://financialmodelingprep.com/api/v3/quote/${e}?apikey=${r}`,o=await fetch(t);o.ok||b(o,"stockDetails",e);const n=await o.json(),a=te(n,e);return P("stockDetails",e,a),a}const v=new Set;function ue(e){const r=!!(e&&e.length>0&&!v.has(e.toLowerCase())),{data:t,error:o,isLoading:n,mutate:a}=p(r?["stock-quote",e]:null,()=>oe(e),{...U,onErrorRetry:O(e,v)});return{data:t||null,error:o,isLoading:n,mutate:a}}export{ue as a,q as b,ce as c,se as d,ie as u,C as v};
